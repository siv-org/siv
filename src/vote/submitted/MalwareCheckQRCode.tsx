import type { Options } from 'qr-code-styling'

import { FullscreenOutlined } from '@ant-design/icons'
import { useEffect, useRef, useState } from 'react'

const sharedOptions: Options = {
  cornersSquareOptions: { color: '#000000', type: 'square' },
  dotsOptions: { type: 'classy-rounded' },
  qrOptions: { errorCorrectionLevel: 'L' },
}

const smallQROptions: Options = {
  ...sharedOptions,
  height: 150,
  imageOptions: { hideBackgroundDots: true, imageSize: 0.5, margin: 0 },
  width: 150,
}

export const MalwareCheckQRCode = ({ className, url }: { className?: string; url: string }) => {
  const ref = useRef<HTMLDivElement>(null)
  const modalRef = useRef<HTMLDivElement>(null)
  const [isModalOpen, setIsModalOpen] = useState(false)

  // Render small QR on initial load
  useEffect(() => {
    if (typeof window === 'undefined') return // Client-side only

    import('qr-code-styling').then(({ default: QRCodeStyling }) => {
      if (!ref.current) return console.warn('Missing QR container ref')
      const qrCode = new QRCodeStyling({ ...smallQROptions, data: url })
      if (ref.current.firstChild) ref.current.removeChild(ref.current.firstChild)
      qrCode.append(ref.current)
    })
  }, [url])

  // Render big QR when modal opened or window resized
  useEffect(() => {
    if (typeof window === 'undefined') return

    const renderQR = () => {
      import('qr-code-styling').then(({ default: QRCodeStyling }) => {
        if (!modalRef.current) return console.warn('Missing modal QR container ref')

        // Calculate responsive size: use 400px or 80vw, whichever is smaller
        const maxSize = Math.min(400, window.innerWidth * 0.8)

        const qrCode = new QRCodeStyling({
          ...sharedOptions,
          data: url,
          height: maxSize,
          margin: 10,
          width: maxSize,
        })
        if (modalRef.current.firstChild) modalRef.current.removeChild(modalRef.current.firstChild)
        qrCode.append(modalRef.current)
      })
    }

    renderQR()

    // Re-render on window resize
    window.addEventListener('resize', renderQR)
    return () => window.removeEventListener('resize', renderQR)
  }, [isModalOpen, url])

  const handleClose = () => setIsModalOpen(false)

  return (
    <>
      {/* Small QR Code */}
      <div className="flex flex-col items-center group">
        <div
          className={`${className || ''} cursor-pointer`}
          onClick={() => setIsModalOpen(true)}
          ref={ref}
          role="button"
          tabIndex={0}
        />
        <button
          className="flex items-center gap-1.5 mb-2 text-xs text-gray-500 group-hover:text-gray-900 transition-colors cursor-pointer bg-transparent border-none p-0"
          onClick={() => setIsModalOpen(true)}
        >
          <FullscreenOutlined className="text-[14px]" />
          <span>Tap for fullscreen</span>
        </button>
      </div>

      {/* Modal */}
      <div
        className={`flex fixed inset-0 z-50 justify-center items-center bg-black bg-opacity-50 ${
          isModalOpen ? '':'hidden'}`}
        onClick={(e: React.MouseEvent) => {
          if (e.target === e.currentTarget) handleClose()
        }}
      >
        <div className="relative p-4 sm:p-8 mx-4 max-w-[90vw] bg-white rounded-lg">
          {/* Close button */}
          <button
            aria-label="Close modal"
            className="absolute top-2 right-2 text-2xl font-bold text-gray-500 bg-transparent border-none cursor-pointer hover:text-gray-700"
            onClick={handleClose}
          >
            ×
          </button>

          <h3 className="mb-3 text-2xl text-center">Scan to Begin</h3>

          {/* Warning */}
          <p className="mt-4 text-sm text-center text-black/60">⚠️ Contains your private vote selections</p>

          {/* Big QR code */}
          <div className="flex justify-center" ref={modalRef} />

          {/* Text link */}
          <p className="mt-4 text-sm text-left break-all">
            Or share this link:
            <a className="block text-blue-600 hover:underline" href={url} rel="noreferrer" target="_blank">
              {url}
            </a>
          </p>
        </div>
      </div>
    </>
  )
}
